name: essential-tests
on:
  pull_request:
    types: [opened, synchronize, reopened]

# default setting
permissions: {}
defaults:
  run:
    shell: bash
# Cancel in-progress jobs on the same branch
concurrency:
  group: gha-nbconvert-${{ github.ref }}
  cancel-in-progress: true

jobs:
  essential-tests:
    runs-on: ubuntu-latest
    name: essential-tests
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"
      - name: Install deps
        run: |
          pip install --no-cache-dir nbconvert==7.16.6 pytest==8.4.1
      - name: Run executor tests
        run: pytest -q
      - name: Run docker-build test
        run: docker build -f ./Dockerfile.dockerfile -t gha-nbconvert:test .
      - name: Create fake GITHUB_EVENT_PATH
        run: |
          sha=$(git rev-parse HEAD)
          printf '{"pull_request":{"base":{"sha":"%s"},"head":{"sha":"%s"}}, "repository":{"full_name":"dummy/dummy"}}' "$sha" "$sha" > event.json
      - name: Run execution test via docker image
        run: |
          mkdir -p artifacts/gha-nbconvert
          docker run --rm \
            -e INPUT_OUTPUT_DIR=artifacts/gha-nbconvert \
            -e GITHUB_WORKSPACE=/github/workspace \
            -e GITHUB_EVENT_PATH=/github/workspace/event.json \
            -e GITHUB_EVENT_NAME=pull_request \
            -e GITHUB_HEAD_REF=main \
            -v "$PWD":/github/workspace \
            gha-nbconvert:test
